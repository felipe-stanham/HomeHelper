{% extends "base.html" %}

{% block content %}
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h1 class="h3 mb-0">HomeHelper Dashboard</h1>
    <div class="text-end">
      <button id="hh-refresh-all" class="btn btn-outline-primary btn-sm">üîÑ Refresh</button>
      <button onclick="viewHomeHelperLogs()" class="btn btn-outline-secondary btn-sm">üìã HomeHelper Logs</button>
      <small class="text-muted d-block">Last Updated: <span id="hh-last-updated">--:--</span></small>
    </div>
  </div>

  <!-- System Status -->
  <section class="mb-3">
    <div class="card hh-card">
      <div class="card-header fw-semibold">System Status</div>
      <div class="card-body" id="hh-system-status">
        <div class="row g-3">
          <div class="col-md-3 col-6">
            <div class="fw-semibold">Redis Message Bus</div>
            <div id="hh-redis-status" class="hh-status-badge text-muted">Loading...</div>
          </div>
          <div class="col-md-3 col-6">
            <div class="fw-semibold">Memory</div>
            <div id="hh-memory-status" class="text-muted">--</div>
          </div>
          <div class="col-md-3 col-6">
            <div class="fw-semibold">Disk</div>
            <div id="hh-disk-status" class="text-muted">--</div>
          </div>
          <div class="col-md-3 col-6">
            <div class="fw-semibold">CPU / Temp</div>
            <div id="hh-cpu-temp-status" class="text-muted">--</div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- App Status Grid -->
  <section class="mb-3">
    <div class="card hh-card">
      <div class="card-header d-flex justify-content-between align-items-center">
        <span class="fw-semibold">App Status</span>
        <button id="hh-refresh-apps" class="btn btn-sm btn-outline-secondary">Refresh Apps</button>
      </div>
      <div class="card-body">
        <div id="hh-app-grid" class="row g-3">
          <!-- App cards will be populated by JS -->
          <div class="col-12 text-muted" id="hh-app-grid-empty">No apps loaded yet.</div>
        </div>
      </div>
    </div>
  </section>

  <!-- Recent Activity / Logs -->
  <section>
    <div class="card hh-card">
      <div class="card-header fw-semibold">Recent Activity</div>
      <div class="card-body">
        <div id="hh-recent-activity" class="text-muted">
          <p class="mb-0">Loading recent activity...</p>
        </div>
      </div>
    </div>
  </section>

  <!-- App Details Modal -->
  <div class="modal fade" id="appDetailsModal" tabindex="-1" aria-labelledby="appDetailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="appDetailsModalLabel">App Details</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body" id="appDetailsContent">
          <div class="text-center"><div class="spinner-border" role="status"><span class="visually-hidden">Loading...</span></div></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Log Viewer Modal -->
  <div class="modal fade" id="logViewerModal" tabindex="-1" aria-labelledby="logViewerModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="logViewerModalLabel">Application Logs</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <button class="btn btn-sm btn-outline-primary" onclick="refreshLogs()">üîÑ Refresh</button>
            <span class="text-muted ms-2">Showing last <span id="logLineCount">50</span> lines</span>
          </div>
          <pre id="logContent" class="bg-dark text-light p-3 rounded" style="max-height: 500px; overflow-y: auto; font-size: 0.85rem;"><code>Loading logs...</code></pre>
        </div>
      </div>
    </div>
  </div>

  <!-- Service App UI Modal -->
  <div class="modal fade" id="serviceUIModal" tabindex="-1" aria-labelledby="serviceUIModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="serviceUIModalLabel">Service UI</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3" id="serviceUINav">
            <!-- Resource tabs will be added here -->
          </div>
          <div id="serviceUIContent">
            <div class="text-center"><div class="spinner-border" role="status"><span class="visually-hidden">Loading...</span></div></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Streamlit App Modal -->
  <div class="modal fade" id="streamlitModal" tabindex="-1" aria-labelledby="streamlitModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-fullscreen">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="streamlitModalLabel">Streamlit App</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body p-0">
          <div id="streamlitLoading" class="text-center p-5">
            <div class="spinner-border" role="status"><span class="visually-hidden">Loading...</span></div>
            <p class="mt-3">Launching Streamlit app...</p>
          </div>
          <iframe id="streamlitFrame" style="width: 100%; height: calc(100vh - 60px); border: none; display: none;"></iframe>
        </div>
      </div>
    </div>
  </div>
{% endblock %}

{% block extra_scripts %}
<script>
  async function fetchJson(url) {
    const resp = await fetch(url);
    if (!resp.ok) {
      throw new Error(`Request failed: ${resp.status}`);
    }
    return await resp.json();
  }

  function formatTime(date) {
    return date.toTimeString().slice(0, 5);
  }

  function setLastUpdated() {
    document.getElementById("hh-last-updated").textContent = formatTime(new Date());
  }

  function renderSystemStatus(health) {
    const extra = health.extra_info || {};
    const hardware = extra.hardware || {};
    const redis = extra.redis || {};

    const cpuUsage = hardware.cpu?.usage_percent ?? "--";
    const temp = hardware.cpu?.temperature_c ?? "--";
    const memUsed = hardware.memory?.used_mb ?? "--";
    const memTotal = hardware.memory?.total_mb ?? "--";
    const memPercent = hardware.memory?.percent ?? "--";
    const diskPercent = hardware.disk?.percent ?? "--";
    const diskUsed = hardware.disk?.used_gb ?? "--";
    const diskTotal = hardware.disk?.total_gb ?? "--";

    const redisStatusEl = document.getElementById("hh-redis-status");
    if (redis.status === "connected") {
      redisStatusEl.textContent = "‚úÖ Connected";
      redisStatusEl.classList.remove("text-muted");
      redisStatusEl.classList.add("text-success");
    } else {
      redisStatusEl.textContent = "‚ùå Disconnected";
      redisStatusEl.classList.remove("text-muted");
      redisStatusEl.classList.add("text-danger");
    }

    document.getElementById("hh-memory-status").textContent =
      memUsed !== "--" && memTotal !== "--"
        ? `${memUsed}MB / ${memTotal}MB (${memPercent}%)`
        : "--";

    document.getElementById("hh-disk-status").textContent =
      diskUsed !== "--" && diskTotal !== "--"
        ? `${diskUsed}GB / ${diskTotal}GB (${diskPercent}%)`
        : "--";

    document.getElementById("hh-cpu-temp-status").textContent =
      `CPU: ${cpuUsage}%  |  Temp: ${temp}¬∞C`;
  }

  function statusBadge(status) {
    if (!status) return "<span class='badge bg-secondary'>‚ö™ Unknown</span>";
    const lower = String(status).toLowerCase();
    if (lower === "running" || lower === "ready" || lower === "good") {
      return "<span class='badge bg-success'>‚úÖ Running</span>";
    }
    if (lower === "warning") {
      return "<span class='badge bg-warning text-dark'>üü° Warning</span>";
    }
    if (lower === "error" || lower === "stopped") {
      return "<span class='badge bg-danger'>‚ùå Error</span>";
    }
    return "<span class='badge bg-secondary'>‚ö™ Unknown</span>";
  }

  function renderApps(apps) {
    const grid = document.getElementById("hh-app-grid");
    
    // Clear only app cards, not the empty message
    const cards = grid.querySelectorAll('.col-12.col-md-6.col-lg-4');
    cards.forEach(card => card.remove());

    const empty = document.getElementById("hh-app-grid-empty");
    
    if (!apps || apps.length === 0) {
      if (empty) empty.style.display = "block";
      return;
    }

    if (empty) empty.style.display = "none";

    for (const app of apps) {
      const col = document.createElement("div");
      col.className = "col-12 col-md-6 col-lg-4";

      const statusHtml = statusBadge(app.status);

      col.innerHTML = `
        <div class="card h-100 hh-card">
          <div class="card-body d-flex flex-column">
            <h5 class="card-title d-flex justify-content-between align-items-center">
              <span>${app.name}</span>
              <small class="text-muted text-uppercase">${app.type}</small>
            </h5>
            <p class="card-text small text-muted mb-2">${app.description || "No description"}</p>
            <p class="mb-2">Status: ${statusHtml}</p>
            <p class="mb-2"><small class="text-muted">Version: ${app.version}</small></p>
            <div class="mt-auto d-flex gap-2">
              <button class="btn btn-sm btn-outline-secondary" onclick="viewAppLogs('${app.app_id}', '${app.name}')">View Logs</button>
              <button class="btn btn-sm btn-outline-primary" onclick="viewAppDetails('${app.app_id}')">Details</button>
            </div>
          </div>
        </div>`;
      grid.appendChild(col);
    }
  }

  function renderRecentActivity(activities) {
    const container = document.getElementById("hh-recent-activity");
    
    if (!activities || activities.length === 0) {
      container.innerHTML = '<p class="mb-0 text-muted">No recent activity</p>';
      return;
    }
    
    let html = '<ul class="list-unstyled mb-0">';
    activities.forEach(activity => {
      const levelClass = activity.level === 'ERROR' ? 'text-danger' : 
                        activity.level === 'WARNING' ? 'text-warning' : 'text-muted';
      const timestamp = activity.timestamp || '';
      const message = activity.message || activity.event || 'Unknown activity';
      
      html += `
        <li class="mb-2 pb-2 border-bottom">
          <small class="${levelClass}">${timestamp}</small>
          <div class="small">${message}</div>
        </li>`;
    });
    html += '</ul>';
    
    container.innerHTML = html;
  }

  async function refreshDashboard() {
    try {
      const [health, appList, activity] = await Promise.all([
        fetchJson("/health"),
        fetchJson("/api/apps"),
        fetchJson("/api/activity/recent?limit=10"),
      ]);
      renderSystemStatus(health);
      renderApps(appList.apps || []);
      renderRecentActivity(activity.data?.activities || []);
      setLastUpdated();
    } catch (err) {
      console.error("Failed to refresh dashboard", err);
    }
  }

  document.getElementById("hh-refresh-all").addEventListener("click", refreshDashboard);
  document.getElementById("hh-refresh-apps").addEventListener("click", async () => {
    try {
      const data = await fetchJson("/api/apps");
      renderApps(data.apps || []);
      setLastUpdated();
    } catch (err) {
      console.error("Failed to refresh apps", err);
    }
  });

  // App details modal
  let currentAppId = null;
  
  async function viewAppDetails(appId) {
    currentAppId = appId;
    const modal = new bootstrap.Modal(document.getElementById('appDetailsModal'));
    const content = document.getElementById('appDetailsContent');
    
    content.innerHTML = '<div class="text-center"><div class="spinner-border" role="status"><span class="visually-hidden">Loading...</span></div></div>';
    modal.show();
    
    try {
      const app = await fetchJson(`/api/apps/${appId}`);
      
      const statusBadgeHtml = statusBadge(app.status);
      const portInfo = app.runtime_info?.assigned_port ? `Port ${app.runtime_info.assigned_port}` : 'No port assigned';
      const serviceStatus = app.runtime_info?.service_status || 'Unknown';
      
      content.innerHTML = `
        <div class="row g-3">
          <div class="col-12">
            <h4>${app.name} ${statusBadgeHtml}</h4>
            <p class="text-muted">${app.description || 'No description'}</p>
          </div>
          
          <div class="col-md-6">
            <div class="card">
              <div class="card-header fw-semibold">App Information</div>
              <div class="card-body">
                <table class="table table-sm">
                  <tr><td class="fw-semibold">App ID:</td><td>${app.app_id}</td></tr>
                  <tr><td class="fw-semibold">Type:</td><td class="text-uppercase">${app.type}</td></tr>
                  <tr><td class="fw-semibold">Version:</td><td>${app.version}</td></tr>
                  <tr><td class="fw-semibold">Status:</td><td>${app.status}</td></tr>
                  <tr><td class="fw-semibold">Path:</td><td><small>${app.path}</small></td></tr>
                </table>
              </div>
            </div>
          </div>
          
          <div class="col-md-6">
            <div class="card">
              <div class="card-header fw-semibold">Runtime Information</div>
              <div class="card-body">
                <table class="table table-sm">
                  <tr><td class="fw-semibold">Assigned Port:</td><td>${portInfo}</td></tr>
                  <tr><td class="fw-semibold">Service Status:</td><td>${serviceStatus}</td></tr>
                  <tr><td class="fw-semibold">Process ID:</td><td>${app.runtime_info?.process_id || 'N/A'}</td></tr>
                  <tr><td class="fw-semibold">Service Name:</td><td>${app.runtime_info?.service_name || 'N/A'}</td></tr>
                </table>
              </div>
            </div>
          </div>
          
          <div class="col-12">
            <div class="card">
              <div class="card-header fw-semibold">Configuration</div>
              <div class="card-body">
                <div class="row">
                  <div class="col-md-3"><strong>Has UI:</strong> ${app.manifest?.config?.has_UI ? '‚úÖ Yes' : '‚ùå No'}</div>
                  <div class="col-md-3"><strong>Redis Required:</strong> ${app.manifest?.config?.redis_required ? '‚úÖ Yes' : '‚ùå No'}</div>
                  <div class="col-md-3"><strong>Auto Start:</strong> ${app.manifest?.config?.auto_start ? '‚úÖ Yes' : '‚ùå No'}</div>
                  <div class="col-md-3"><strong>Restart Policy:</strong> ${app.manifest?.config?.restart_policy || 'N/A'}</div>
                </div>
              </div>
            </div>
          </div>
          
          <div class="col-12 text-end">
            <button class="btn btn-outline-secondary" onclick="viewAppLogs('${app.app_id}', '${app.name}')">View Logs</button>
            ${app.type === 'streamlit' ? `
              <button class="btn btn-primary" onclick="launchStreamlitApp('${app.app_id}', '${app.name}')">üöÄ Launch Streamlit</button>
            ` : ''}
            ${app.type === 'service' && app.manifest?.config?.has_UI ? `
              <button class="btn btn-outline-primary" onclick="viewServiceUI('${app.app_id}', '${app.name}')">üñ•Ô∏è View UI</button>
            ` : ''}
            ${app.type === 'service' ? `
              <button class="btn btn-outline-success" onclick="startApp('${app.app_id}')">Start</button>
              <button class="btn btn-outline-warning" onclick="stopApp('${app.app_id}')">Stop</button>
              <button class="btn btn-outline-info" onclick="restartApp('${app.app_id}')">Restart</button>
            ` : ''}
          </div>
        </div>
      `;
    } catch (err) {
      content.innerHTML = `<div class="alert alert-danger">Failed to load app details: ${err.message}</div>`;
    }
  }
  
  // Log viewer modal
  let currentLogAppId = null;
  let currentLogAppName = null;
  
  async function viewAppLogs(appId, appName) {
    currentLogAppId = appId;
    currentLogAppName = appName;
    
    const modal = new bootstrap.Modal(document.getElementById('logViewerModal'));
    document.getElementById('logViewerModalLabel').textContent = `${appName} - Logs`;
    modal.show();
    
    await refreshLogs();
  }
  
  async function refreshLogs() {
    if (!currentLogAppId) return;
    
    const logContent = document.getElementById('logContent');
    logContent.innerHTML = '<code>Loading logs...</code>';
    
    try {
      const response = await fetchJson(`/api/apps/${currentLogAppId}/logs?lines=100`);
      const logs = response.data?.logs || [];
      
      if (logs.length === 0) {
        const message = response.data?.message || 'No logs available';
        logContent.innerHTML = `<code class="text-muted">${message}</code>`;
      } else {
        logContent.innerHTML = `<code>${logs.join('\n')}</code>`;
        document.getElementById('logLineCount').textContent = logs.length;
      }
    } catch (err) {
      logContent.innerHTML = `<code class="text-danger">Failed to load logs: ${err.message}</code>`;
    }
  }
  
  async function viewHomeHelperLogs() {
    currentLogAppId = null;  // Clear app-specific log ID
    currentLogAppName = 'HomeHelper';
    
    const modal = new bootstrap.Modal(document.getElementById('logViewerModal'));
    document.getElementById('logViewerModalLabel').textContent = 'HomeHelper - Main Application Logs';
    modal.show();
    
    const logContent = document.getElementById('logContent');
    logContent.innerHTML = '<code>Loading logs...</code>';
    
    try {
      const response = await fetchJson('/api/logs/homehelper?lines=100');
      const logs = response.data?.logs || [];
      
      if (logs.length === 0) {
        const message = response.data?.message || 'No logs available';
        logContent.innerHTML = `<code class="text-muted">${message}</code>`;
      } else {
        logContent.innerHTML = `<code>${logs.join('\n')}</code>`;
        document.getElementById('logLineCount').textContent = logs.length;
      }
    } catch (err) {
      logContent.innerHTML = `<code class="text-danger">Failed to load logs: ${err.message}</code>`;
    }
  }
  
  // Service control functions
  async function startApp(appId) {
    try {
      await fetch(`/api/services/${appId}/start`, { method: 'POST' });
      alert('Service start command sent');
      await viewAppDetails(appId);
    } catch (err) {
      alert(`Failed to start service: ${err.message}`);
    }
  }
  
  async function stopApp(appId) {
    try {
      await fetch(`/api/services/${appId}/stop`, { method: 'POST' });
      alert('Service stop command sent');
      await viewAppDetails(appId);
    } catch (err) {
      alert(`Failed to stop service: ${err.message}`);
    }
  }
  
  async function restartApp(appId) {
    try {
      await fetch(`/api/services/${appId}/restart`, { method: 'POST' });
      alert('Service restart command sent');
      await viewAppDetails(appId);
    } catch (err) {
      alert(`Failed to restart service: ${err.message}`);
    }
  }

  // Streamlit app launcher
  let currentStreamlitAppId = null;
  let streamlitTouchInterval = null;
  
  async function launchStreamlitApp(appId, appName) {
    currentStreamlitAppId = appId;
    
    const modal = new bootstrap.Modal(document.getElementById('streamlitModal'));
    document.getElementById('streamlitModalLabel').textContent = appName;
    
    const loadingEl = document.getElementById('streamlitLoading');
    const frameEl = document.getElementById('streamlitFrame');
    
    loadingEl.style.display = 'block';
    frameEl.style.display = 'none';
    frameEl.src = '';
    
    modal.show();
    
    try {
      // Launch Streamlit app
      const response = await fetch(`/api/apps/${appId}/streamlit/launch`, { method: 'POST' });
      
      if (!response.ok) {
        throw new Error(`Failed to launch: ${response.statusText}`);
      }
      
      const result = await response.json();
      
      // Load Streamlit in iframe
      frameEl.src = result.url;
      
      // Wait for iframe to load
      frameEl.onload = () => {
        loadingEl.style.display = 'none';
        frameEl.style.display = 'block';
      };
      
      // Set up TTL touch interval (every 60 seconds)
      if (streamlitTouchInterval) {
        clearInterval(streamlitTouchInterval);
      }
      streamlitTouchInterval = setInterval(() => {
        fetch(`/api/apps/${appId}/streamlit/touch`, { method: 'POST' });
      }, 60000);
      
    } catch (err) {
      loadingEl.innerHTML = `<div class="alert alert-danger m-3">Failed to launch Streamlit app: ${err.message}</div>`;
    }
  }
  
  // Clean up Streamlit touch interval when modal closes
  document.getElementById('streamlitModal').addEventListener('hidden.bs.modal', () => {
    if (streamlitTouchInterval) {
      clearInterval(streamlitTouchInterval);
      streamlitTouchInterval = null;
    }
  });

  // Service UI viewer
  let currentServiceUIAppId = null;
  let currentServiceUIResources = [];
  
  async function viewServiceUI(appId, appName) {
    currentServiceUIAppId = appId;
    
    const modal = new bootstrap.Modal(document.getElementById('serviceUIModal'));
    document.getElementById('serviceUIModalLabel').textContent = `${appName} - UI`;
    
    const navEl = document.getElementById('serviceUINav');
    const contentEl = document.getElementById('serviceUIContent');
    
    navEl.innerHTML = '';
    contentEl.innerHTML = '<div class="text-center"><div class="spinner-border" role="status"><span class="visually-hidden">Loading...</span></div></div>';
    
    modal.show();
    
    try {
      // Discover UI resources
      const response = await fetchJson(`/api/apps/${appId}/ui/resources`);
      
      if (!response.has_ui || response.resources.length === 0) {
        contentEl.innerHTML = '<div class="alert alert-info">This service does not expose any UI resources.</div>';
        return;
      }
      
      currentServiceUIResources = response.resources;
      
      // Create resource tabs
      let tabsHtml = '<ul class="nav nav-tabs" role="tablist">';
      response.resources.forEach((resource, index) => {
        const active = index === 0 ? 'active' : '';
        tabsHtml += `
          <li class="nav-item" role="presentation">
            <button class="nav-link ${active}" id="tab-${resource}" data-bs-toggle="tab" 
                    data-bs-target="#content-${resource}" type="button" role="tab"
                    onclick="loadServiceUIResource('${appId}', '${resource}')">
              ${resource.charAt(0).toUpperCase() + resource.slice(1)}
            </button>
          </li>`;
      });
      tabsHtml += '</ul>';
      navEl.innerHTML = tabsHtml;
      
      // Load first resource
      await loadServiceUIResource(appId, response.resources[0]);
      
    } catch (err) {
      contentEl.innerHTML = `<div class="alert alert-danger">Failed to load UI: ${err.message}</div>`;
    }
  }
  
  async function loadServiceUIResource(appId, resource) {
    const contentEl = document.getElementById('serviceUIContent');
    contentEl.innerHTML = '<div class="text-center"><div class="spinner-border" role="status"><span class="visually-hidden">Loading...</span></div></div>';
    
    try {
      const response = await fetchJson(`/api/apps/${appId}/ui/${resource}`);
      
      contentEl.innerHTML = `
        <div class="mb-2">
          <strong>${response.count}</strong> ${resource} found
          <button class="btn btn-sm btn-outline-primary float-end" onclick="loadServiceUIResource('${appId}', '${resource}')">üîÑ Refresh</button>
        </div>
        ${response.html}
      `;
    } catch (err) {
      contentEl.innerHTML = `<div class="alert alert-danger">Failed to load ${resource}: ${err.message}</div>`;
    }
  }

  // Initial load
  refreshDashboard();
</script>
{% endblock %}
